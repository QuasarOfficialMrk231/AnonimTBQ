<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonim Browser</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #browser-container { display: flex; flex-direction: column; height: 100vh; }
        #url-bar { padding: 10px; background: #f1f1f1; display: flex; border-bottom: 1px solid #ccc; }
        #url-input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        #go-button { padding: 5px 10px; margin-left: 5px; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; }
        iframe { flex: 1; border: none; }
        #timer { padding: 5px 10px; background-color: #f1f1f1; border-top: 1px solid #ccc; text-align: center; font-size: 14px; }
    </style>
</head>
<body>
    <div id="browser-container">
        <div id="url-bar">
            <input type="text" id="url-input" placeholder="Enter URL..." />
            <button id="go-button">Go</button>
        </div>
        <iframe id="browser-frame" 
                sandbox="allow-forms allow-scripts" 
                referrerpolicy="no-referrer"
                title="Anonim Browser"></iframe>
        <div id="timer">Время на сайте: 0 сек.</div>
    </div>

    <script>
        const urlInput = document.getElementById('url-input');
        const goButton = document.getElementById('go-button');
        const browserFrame = document.getElementById('browser-frame');
        const timerDisplay = document.getElementById('timer');
        
        let startTime = 0;
        let timerInterval = null;

        // Функция для перехода на сайт через KProxy
        function navigateToUrl(url = '') {
            if (!url) {
                url = urlInput.value.trim();
            }
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }

            // Обнуляем iframe перед загрузкой нового сайта (очистка контекста)
            browserFrame.src = 'about:blank';
            setTimeout(() => {
                browserFrame.src = 'https://www.kproxy.com/servlet/redirect.srv/sruj/sruj/' + btoa(url);
                startTimer();
            }, 100);
        }

        // Автозагрузка сайта при открытии (если указан в URL ?url=...)
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const autoUrl = urlParams.get('url');
            if (autoUrl) {
                urlInput.value = autoUrl;
                navigateToUrl(autoUrl);
            }
        };

        goButton.addEventListener('click', () => navigateToUrl());

        // Очистка данных браузера и защита от отслеживания
        browserFrame.addEventListener('load', () => {
            try {
                const win = browserFrame.contentWindow;

                // Очистка истории
                win.history.replaceState(null, '', '/');

                // Очистка localStorage и sessionStorage
                win.localStorage.clear();
                win.sessionStorage.clear();

                // Удаление всех cookies
                const cookies = win.document.cookie.split("; ");
                for (const cookie of cookies) {
                    const eqPos = cookie.indexOf("=");
                    const name = eqPos > -1 ? cookie.slice(0, eqPos) : cookie;
                    win.document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                }

                // Блокировка WebRTC
                win.navigator.mediaDevices.getUserMedia = () => Promise.reject(new Error('WebRTC отключен'));

                // Подмена User-Agent
                Object.defineProperty(win.navigator, 'userAgent', {
                    get: () => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36'
                });

                // Удаление скриптов отслеживания
                const scripts = win.document.querySelectorAll('script[src*="analytics"], script[src*="tracker"]');
                scripts.forEach(script => script.remove());

                // Блокировка API геолокации
                win.navigator.geolocation.getCurrentPosition = () => {
                    throw new Error('Geolocation отключена');
                };

            } catch (e) {
                console.warn("Не удалось очистить данные или заблокировать трекинг: ", e);
            }
        });

        // Функции для отслеживания времени на сайте
        function startTimer() {
            clearInterval(timerInterval);
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            timerDisplay.textContent = `Время на сайте: ${elapsed} сек.`;
        }
    </script>
</body>
</html>